<Deployment xmlns="https://cogito.cx/schemas/SqlServer/Deployment/2020">
    <Parameter Name="SetupExePath" DefaultValue="D:\setup.exe" />
    <Parameter Name="SQL_InstanceName" DefaultValue="(local)\SQL" />
    <Parameter Name="EFM_InstanceName" DefaultValue="(local)\EFM" />
    <Parameter Name="DST_InstanceName" DefaultValue="(local)\DST" />
    <Parameter Name="PathToJcmsDacPac" DefaultValue="C:\dev\Cogito.SqlServer.Deployment\Database1\bin\Debug\Database1.dacpac" />
    <Parameter Name="PathToConversionDacPac" DefaultValue="C:\dev\Cogito.SqlServer.Deployment\Database1\bin\Debug\Database1.dacpac" />
    <Parameter Name="PathToExchangeDacPac" DefaultValue="C:\dev\Cogito.SqlServer.Deployment\Database1\bin\Debug\Database1.dacpac" />
    <Parameter Name="DistributorAdminPassword" DefaultValue="distributor_admin" />
    <Parameter Name="SnapshotAgentUserName" DefaultValue="" />
    <Parameter Name="SnapshotAgentPassword" DefaultValue="" />
    <Parameter Name="LogReaderAgentUserName" DefaultValue="" />
    <Parameter Name="LogReaderAgentPassword" DefaultValue="" />
    <Target Name="DST">
        <Instance Name="[DST_InstanceName]">
            <Setup Exe="[SetupExePath]" />
            <Distributor AdminPassword="[DistributorAdminPassword]" />
        </Instance>
    </Target>
    <Target Name="SQL">
        <Instance Name="[SQL_InstanceName]">
            <Setup Exe="[SetupExePath]" />
            <Configuration Name="clr enabled" Value="1" />
        </Instance>
    </Target>
    <Target Name="SQL_REPL">
        <Instance Name="[SQL_InstanceName]">
            <RemoteDistributor InstanceName="[DST_InstanceName]" AdminPassword="[DistributorAdminPassword]" />
        </Instance>
    </Target>
    <Target Name="EFM">
        <Instance Name="[EFM_InstanceName]">
            <Setup Exe="[SetupExePath]" />
            <Configuration Name="clr enabled" Value="1" />
        </Instance>
    </Target>
    <Target Name="EFM_REPL">
        <Instance Name="[EFM_InstanceName]">
            <RemoteDistributor InstanceName="[DST_InstanceName]" AdminPassword="[DistributorAdminPassword]" />
        </Instance>
    </Target>
    <Target Name="SQL_TO_EFM">
        <DependsOn Name="SQL" />
        <DependsOn Name="EFM" />
        <Instance Name="[SQL_InstanceName]">
            <LinkedServer Name="NEON" DataSource="[EFM_InstanceName]" />
        </Instance>
    </Target>
    <Target Name="EFM_TO_SQL">
        <DependsOn Name="EFM" />
        <DependsOn Name="SQL" />
        <Instance Name="[EFM_InstanceName]">
            <LinkedServer Name="JCMS" DataSource="[SQL_InstanceName]" />
        </Instance>
    </Target>
    <Target Name="SQL_JCMS">
        <DependsOn Name="SQL" />
        <DependsOn Name="SQL_TO_EFM" />
        <Instance Name="[SQL_InstanceName]">
            <Database Name="JCMS">
                <Package Source="[PathToJcmsDacPac]" />
            </Database>
        </Instance>
    </Target>
    <Target Name="SQL_Conversion">
        <DependsOn Name="SQL" />
        <Instance Name="[SQL_InstanceName]">
            <Database Name="Conversion" Package="[PathToConversionDacPac]" />
        </Instance>
    </Target>
    <Target Name="EFM_JCMS">
        <DependsOn Name="EFM" />
        <DependsOn Name="SQL_JCMS" />
        <DependsOn Name="SQL_REPL" />
        <DependsOn Name="EFM_REPL" />
        <Instance Name="[SQL_InstanceName]">
            <TransactionalPublication Name="JCMS" DatabaseName="JCMS">
                <SnapshotAgent>
                    <ProcessCredentials UserName="[SnapshotAgentUserName]" Password="[SnapshotAgentPassword]" />
                </SnapshotAgent>
                <LogReaderAgent>
                    <ProcessCredentials UserName="[LogReaderAgentUserName]" Password="[LogReaderAgentPassword]" />
                </LogReaderAgent>
            </TransactionalPublication>
        </Instance>
        <Instance Name="[EFM_InstanceName]">
            <Subscription Name="JCMS" Publisher="[SQL_InstanceName]" Publication="JCMS" />
        </Instance>
    </Target>
    <Target Name="EFM_Exchange">
        <DependsOn Name="EFM" />
        <Instance Name="[EFM_InstanceName]">
            <Database Name="Exchange">
                <Package Source="[PathToExchangeDacPac]">
                    <DeployOptions>
                        <SqlCommandVariableValues>
                            <SqlCommandVariableValue Name="Foo" Value="Bar" />
                        </SqlCommandVariableValues>
                    </DeployOptions>
                </Package>
            </Database>
        </Instance>
    </Target>
</Deployment>
