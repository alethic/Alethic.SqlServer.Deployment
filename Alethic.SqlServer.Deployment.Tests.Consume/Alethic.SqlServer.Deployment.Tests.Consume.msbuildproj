<Project>
    <Import Sdk="Microsoft.Build.NoTargets" Version="3.0.4" Project="Sdk.props" />

    <PropertyGroup>
        <TargetFramework>netstandard2.0</TargetFramework>
    </PropertyGroup>

    <ItemGroup>
        <ProjectReference Include="..\Alethic.SqlServer.Deployment.Tests\Alethic.SqlServer.Deployment.Tests.csproj">
            <SetTargetFramework>TargetFramework=netcoreapp3.1</SetTargetFramework>
        </ProjectReference>
    </ItemGroup>

    <Import Sdk="Microsoft.Build.NoTargets" Version="3.0.4" Project="Sdk.targets" />

    <Target Name="GetPublishItems" DependsOnTargets="ResolveProjectReferences" Inputs="@(ProjectReferenceWithConfiguration)" Outputs="%(ProjectReferenceWithConfiguration.Identity)\dummy">
        <MSBuild Projects="@(ProjectReferenceWithConfiguration)" Targets="PublishItemsOutputGroup" BuildInParallel="$(BuildInParallel)" Properties="%(ProjectReferenceWithConfiguration.SetConfiguration);%(ProjectReferenceWithConfiguration.SetPlatform);%(ProjectReferenceWithConfiguration.SetTargetFramework)" RemoveProperties="%(ProjectReferenceWithConfiguration.GlobalPropertiesToRemove);Location;" RebaseOutputs="true">
            <Output TaskParameter="TargetOutputs" ItemName="_PublishItemsOutput" />
        </MSBuild>
        <Message Text="_PublishItemsOutput: @(_PublishItemsOutput)" Importance="high" />
    </Target>

    <PropertyGroup>
        <GetCopyToOutputDirectoryItemsDependsOn>
            $(GetCopyToOutputDirectoryItemsDependsOn);
            GetTestCopyToOutputDirectoryItems
        </GetCopyToOutputDirectoryItemsDependsOn>
    </PropertyGroup>

    <Target Name="GetTestCopyToOutputDirectoryItems" BeforeTargets="DefaultCopyToPublishDirectoryMetadata" DependsOnTargets="GetPublishItems">
        <ItemGroup>
            <ContentWithTargetPath Include="@(_PublishItemsOutput)">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
                <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
                <TargetPath>pub\%(TargetPath)</TargetPath>
            </ContentWithTargetPath>
        </ItemGroup>
    </Target>

</Project>